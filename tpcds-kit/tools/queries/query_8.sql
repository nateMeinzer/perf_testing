select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '87291','32404','16325','68812','23972','77539',
                          '58411','17026','86284','60436','38607',
                          '77817','24891','90885','17903','18409',
                          '57591','59344','51089','89531','55548',
                          '17166','54584','36937','78365','53095',
                          '18359','57508','74517','21739','29724',
                          '39192','59021','51595','96842','25972',
                          '50790','17291','37493','10373','18828',
                          '83550','72679','41350','50659','31277',
                          '81607','57693','34425','56644','70400',
                          '25113','60718','77453','94899','44623',
                          '68007','41231','48566','71948','37119',
                          '68341','74828','13559','38105','49130',
                          '19303','19832','23956','29785','79170',
                          '71637','19047','89977','24971','20971',
                          '55817','57648','30049','24986','57817',
                          '27413','39736','95788','16515','24206',
                          '42115','96826','21178','16004','76090',
                          '16634','37665','44615','98342','24307',
                          '15727','49578','27051','19444','15091',
                          '47190','85816','94790','45042','77433',
                          '41807','36035','63964','21726','47945',
                          '70029','67450','78298','20819','20243',
                          '31654','51781','17325','11376','25748',
                          '97672','36429','57024','44921','95328',
                          '57197','12918','35833','71624','44096',
                          '23427','11127','49840','57553','43830',
                          '71144','61451','16496','18699','90208',
                          '70873','38742','20011','28570','96559',
                          '57838','56354','75640','99555','18026',
                          '23515','37697','14770','30105','31441',
                          '81140','39163','82527','68689','13337',
                          '45358','82601','98069','85066','49363',
                          '47288','98862','23899','17964','47528',
                          '48425','39895','35925','28541','25614',
                          '21105','44148','80929','43509','70721',
                          '49210','14311','93797','74335','18926',
                          '81914','17599','16873','14646','21059',
                          '41255','67737','34622','64060','71850',
                          '51707','36955','49018','45675','35618',
                          '70449','84329','98337','25263','36851',
                          '34895','76698','64438','25727','19488',
                          '72408','50952','22246','68769','31322',
                          '19987','12189','60142','11617','12397',
                          '29668','41351','38664','13968','78550',
                          '97172','14819','26494','35519','17879',
                          '41967','53268','14655','54189','56249',
                          '67065','38749','14850','68101','46164',
                          '63626','21326','19736','24659','72991',
                          '95042','41918','15542','55854','52440',
                          '11911','59385','33265','23743','33467',
                          '25709','71234','36617','18767','63193',
                          '47354','80601','21375','21286','33158',
                          '21894','67301','10182','81962','51302',
                          '13434','91010','72536','98237','53162',
                          '73146','77721','10505','65147','93497',
                          '46131','92454','15555','50016','13377',
                          '37519','70355','67013','59851','72151',
                          '98532','52388','18620','60641','17133',
                          '64528','59407','61050','45532','11489',
                          '91338','40116','19752','22910','11157',
                          '27156','62205','32668','47099','51932',
                          '70332','74451','27880','14154','58263',
                          '49251','60279','71095','79604','91830',
                          '59493','12619','81450','37913','74685',
                          '76125','61869','31004','61781','33425',
                          '14175','48121','21879','98025','17739',
                          '56223','13862','89610','54824','64440',
                          '86057','21309','62360','50787','76246',
                          '11361','36562','36729','60082','21204',
                          '22461','90228','61024','37952','35389',
                          '61102','39499','26689','52868','38193',
                          '79519','40145','11339','48060','61793',
                          '71996','30414','94983','29449','35816',
                          '33562','85709','83832','61860','10453',
                          '36041','72667','99176','32071','73803',
                          '19402','99131','89624','12585','43071',
                          '48016','57680','32918','27116','28239',
                          '42276','29581','60539','16790','21342',
                          '47982','18568','61959','15474')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;
