select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '51640','49699','82312','80032','12897','55984',
                          '54530','67535','49118','18601','16733',
                          '42639','51878','47815','21587','31819',
                          '31903','28863','81398','44142','45114',
                          '40302','44881','82058','83753','59162',
                          '37146','46398','43280','55117','43670',
                          '36519','77935','13015','27934','42764',
                          '59231','42501','93402','21137','13932',
                          '74268','95425','75005','57183','15529',
                          '12967','21677','30728','23765','27293',
                          '41852','68798','48571','57104','44853',
                          '18359','14429','54090','62125','10425',
                          '32204','41139','79545','40734','58214',
                          '81618','77136','87459','74931','44128',
                          '28788','13768','42975','54225','23142',
                          '98293','93675','12301','31813','55954',
                          '81581','28608','12138','62878','33508',
                          '83832','83585','95172','53489','57870',
                          '66750','20265','42096','22014','92168',
                          '46211','25748','63049','98827','89784',
                          '59532','76967','70147','13738','97662',
                          '62081','47318','30828','13408','25410',
                          '33317','42808','46687','43941','71211',
                          '46364','34851','54884','99984','78449',
                          '37405','93822','73495','21566','87151',
                          '13605','14233','56444','49512','16789',
                          '75595','21743','85088','35197','86177',
                          '46844','87261','79484','29344','13880',
                          '47082','17857','77744','52745','10835',
                          '22044','74998','42027','77011','26611',
                          '52552','86100','10607','11259','18963',
                          '55712','48211','15963','31194','44286',
                          '92020','39550','70195','18451','54431',
                          '44384','82907','32109','28207','93798',
                          '61460','99735','12345','25166','62311',
                          '47268','55128','19081','11421','29782',
                          '92832','31218','28390','34690','85841',
                          '35854','71524','43004','32751','69262',
                          '17350','83670','58885','75919','45354',
                          '91040','32252','97406','21049','37167',
                          '88901','76466','29801','86572','98173',
                          '12544','72863','13359','19505','27259',
                          '29532','60164','75492','19175','28800',
                          '47548','43234','48177','61036','30729',
                          '15745','50098','33937','96255','56659',
                          '44650','97147','40361','72807','11234',
                          '17282','93192','92436','44706','35482',
                          '22786','52547','18833','40663','18380',
                          '77526','91316','36114','66159','68574',
                          '52079','71888','35094','60112','32748',
                          '69518','43398','26844','93974','54677',
                          '46177','62869','87434','38960','76659',
                          '66726','63517','90546','85094','13879',
                          '38595','84214','38187','63955','71799',
                          '27410','52554','30692','21909','41063',
                          '95080','34422','38829','66753','17169',
                          '75088','92024','79808','80539','28803',
                          '28847','26462','46385','52351','42891',
                          '82226','30676','41115','44307','79016',
                          '15962','26215','40985','31652','96293',
                          '34907','44873','15145','96226','21444',
                          '67090','63657','33481','95377','11785',
                          '12154','77623','52839','31294','86611',
                          '33232','25364','71375','17821','57170',
                          '44127','34084','51050','82712','89184',
                          '84580','24670','77497','77144','57802',
                          '15565','80939','38607','92162','65826',
                          '55590','68326','88942','40201','83549',
                          '26026','30146','29992','24237','98908',
                          '66819','32931','50107','23460','47523',
                          '25963','61802','49317','42134','48466',
                          '66372','89375','61266','81272','92552',
                          '16561','87533','50843','31396','82331',
                          '24346','57886','95738','60005','99511',
                          '70965','79455','83983','95733','26339',
                          '18194','92971','52682','47040','11196',
                          '59341','59025','82497','87412','26546',
                          '53404','92058','41150','14626','97749',
                          '43977','24154','33887','70291','95709',
                          '94981','51813','84592','23102')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;
